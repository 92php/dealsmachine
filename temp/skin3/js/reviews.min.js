// JavaScript Document

jQuery.extend({
getCookie : function(sName) {
    var aCookie = document.cookie.split("; ");
    for (var i=0; i < aCookie.length; i++){
      var aCrumb = aCookie[i].split("=");
      if (sName == aCrumb[0]) return decodeURIComponent(aCrumb[1]);
    }
    return '';
},
setCookie : function(sName, sValue, sExpires) {
    var sCookie = sName + "=" + encodeURIComponent(sValue);
    if (sExpires != null) sCookie += "; expires=" + sExpires;
    document.cookie = sCookie;
},
removeCookie : function(sName) {
    document.cookie = sName + "=; expires=Fri, 31 Dec 1999 23:59:59 GMT;";
}
}); 


function check_btn_signin(){
		var username=$("#username").val();
		var password=$("#password").val();
		if(username.length!=''){
			var p=/^[\w-]+(\.[\w-]+)*@[\w-]+(\.[\w-]+)+$/;
			if(!p.test(username)){
				$("#rw_sign_msg").html("<span style='color:red'>"+reviews_func_check_btn_signin_0+"</span>");
				return false;
			}
		}
		else{
			$("#rw_sign_msg").html("<span style='color:red'>"+reviews_func_check_btn_signin_1+"</span>");
			return false;
		}
		if(password ==''){
			$("#rw_sign_msg").html("<span style='color:red'>"+reviews_func_check_btn_signin_2+"</span>");
			return false;
		}else{
			$.ajax({
			  type:"post",
			  data:"email="+username+"&password="+password,
			  url: '/'+js_cur_lang_url + "m-users-a-act_sign.htm",
			  cache: false,
			  timeout: 5000,
              error: function (xmlHttpRequest, errors) {
				  			alert(errors);
                            $("#rw_sign_msg").html("<span style='color:red'>"+errors+"</span>");
                   },
			  beforeSend :function(){
				  $("#rw_sign_msg").html("<span style='color:green'>"+reviews_func_check_btn_signin_3+"</span>");
				  },
			  success: function(data){
				if(data!='Successfully sign'){
					$("#rw_sign_msg").html("<span style='color:red'>"+data+"</span>");
				}else{
					nickname = $.getCookie("fullname");
					$("#re_nickname").val(nickname);
					$("#sp_nickname").show();
					$(".login_tips").html('(1000 '+ characters +')');
					$("#js_comment_signBox").hide();
					GLOBAL.isLogin();
				}}
			}); }}
	function is_signin(){
		//islogin();
		str=$('#js_islogin').html();
		if(str.indexOf("Register") > 0){
			return false;
		}else
			return true;
		var flag =1;
		$.ajax({
		type: "GET",
		cache:false,
		url: '/fun/index.php?act=chk_sign',
		success: function(msg){
			if (msg){
				//alert("1");				
				 flag = 1;
			}else{
				//alert("0");	
				flag = 0;
			}
			} 
		});
		return flag;
	}
	
	$('.replyBtn ').click(function(){
		var _this = $(this);
		var rid = $(this).attr("rid");
		var nickname = $.getCookie("fullname");
		var $thisParentBox = $(this).parents("div.commentReplyBox");
		var formHtml = '<div class="formBox js_formBox">';
			  formHtml+='<div class="comment_input">';
			  formHtml+='<textarea name="re_content" id="js_re_content" cols="30" rows="10" class="re_content" rid="49559"></textarea>';
			  formHtml+='<div class="comment_input_btnWarp clearfix">';
			  formHtml+='<input type="submit" id="js_bt_post_reply" class="comment_upBtn" onclick="post_reply()" value=""/>';
			  formHtml+='<p class="fr mr10" id="sp_nickname" style="display:none;"><label for="">'+ nick_name +':</label><input size="20" type="text" name="nickname" id="re_nickname" /></p>';
			  formHtml+='<p class="login_tips"><a href="javascript:void(0)" class="blue_link mr10" onClick="$(&#39;#js_comment_signBox&#39;).toggle();">sign in</a>or<a href="/sign-up/" class="blue_link ml10">register</a></p>';
			  formHtml+='</div>';
			  formHtml+='</div>';
			  formHtml+='<div id="js_comment_signBox" class="commet_signBox" style="display:none;">';
			  formHtml+='<p id="rw_sign_msg" class="red"></p>';
			  formHtml+='<p><label for="usernamer" class="fl">Email:</label><input type="text" size="20"  id="username" name="username" />New customer? <a class="blue_link" href="/sign-up/">Start here.</a></p>';
			  formHtml+='<p><label for="password" class="fl">Password:</label><input type="password" size="20"  id="password" name="password" />Forgot your account or password?<a id="getpassword" class="vipmorex" onClick = "forgetpsw();return false;" href="m-users-a-forgot.htm">click here </a></p>';
			  formHtml+='<p class="comment_signBox_btn"><input type="submit" onclick="check_btn_signin()" value="Sign in"/></p>';
			  formHtml+='</div>';
			  formHtml+='</div>';
			  
		$("div.commentReplyBox").find(".js_formBox").remove();
	
		if(_this.hasClass('replyBtn_on')){
			_this.removeClass("replyBtn_on");
		}else{
			$('.replyBtn ').each(function(){$(this).removeClass('replyBtn_on')});//移除其他的留言框
			_this.addClass("replyBtn_on");
			$thisParentBox.append($(formHtml));//当前回复框写入页面
			$("#re_nickname").val(nickname);//从cookie中读出用户名，并赋值
			if(!is_signin()){//如果已经登录了
				$(".login_tips").html('<a href="javascript:void(0)" class="blue_link mr10" onClick="$(&#39;#js_comment_signBox&#39;).toggle();">sign in</a>or<a href="/sign-up/" class="blue_link ml10">register</a>');
			}else{
				$(".login_tips").html('(1000 '+ characters +')');
				$("#sp_nickname").show();
			}
			$("#js_re_content").attr("rid",rid);
		}
		
	});
	
	
	function post_reply(goods_id){
		if(!is_signin()){
			alert(reviews_func_post_reply_0);
			$("#js_comment_signBox").show();
			$("#username").focus();
			return false;
		}else{
			var re_content=$("#js_re_content").val();
			re_content=jQuery.trim(re_content);
			var re_nickname=$("#re_nickname").val();
			re_nickname=jQuery.trim(re_nickname);
			var rid = $("#js_re_content").attr("rid");
			msg="";
			if(rid==""||isNaN(rid)){
				alert(reviews_func_post_reply_1);
				return false;
			}
			if(re_content==""){
				msg+=reviews_func_post_reply_2;
				$(".re_content").focus();
			}
			if(re_nickname==""){
				msg+=reviews_func_post_reply_3;
				if(msg=="") $("#re_nickname").focus();
			}
			if(msg!=""){alert(msg);return false;}
			var $bt_post_reply = $("#js_bt_post_reply");
			var $logdingImg = $('<img style="display:inline;float:right" src="temp/skin3/images/styleimg/indicator.gif"/>');
			//bt_img=$("#bt_post_reply").attr("src");
			$.ajax({
			  type:"post",
			  data:{'re_content':re_content,'re_nickname':re_nickname,'rid':rid},
			  url: '/'+js_cur_lang_url + "m-review-a-save_review_reply-goods_id-"+goods_id+".htm",
			  cache: false,
			  timeout: 5000,
              error: function (xmlHttpRequest, error) {
				  $bt_post_reply.parent().find($logdingImg).remove();
				  $bt_post_reply.show();
			  },
			  beforeSend :function(){
				  $bt_post_reply.hide();
				  $bt_post_reply.before($logdingImg);
			   },
			  success: function(data){
				   $bt_post_reply.parent().find($logdingImg).remove();
				   $bt_post_reply.show();
				   $(".re_content").val("");
				if(data=='success'){
					alert(reviews_func_post_reply_4);
				}else{
					nickname = $.getCookie("fullname");
					$("#re_nickname").val(nickname);
					$("#sp_nickname").show();
					$(".login_tips").html('(1000 '+ characters +')');
					$("#js_comment_signBox").hide();
					alert(data);
				}
				
			  }
			}); 			
		}}
		function forgetpsw(){
		//alert();
		 ymPrompt.setDefaultCfg({okTxt:' '+ send +' ',cancelTxt:' '+ cancel +' ',closeTxt:''+ close_txt +'',minTxt:''+ minimize +'',maxTxt:''+ maximize +''});
         ymPrompt.confirmInfo({icoCls:'',msgCls:'confirm',message:reviews_func_forgetpsw_0+"<br><input type='text' id='myInput' onfocus='this.select()' />",title:reviews_func_forgetpsw_1,height:150,handler:getpassInput,autoClose:false});	
	}
	function getpassInput(tp){
		if(tp!='ok') return ymPrompt.close();
		var v=$('#myInput').val();
		v = v.replace('-','=');
		if(v=='' || v.indexOf('@')<0 || v.indexOf('.')<0  )
			alert(reviews_func_getpassInput_0);
		else{
			window.location.href = '/'+js_cur_lang_url + 'm-users-a-send_pwd_email_check-e-'+v+'.htm';
			ymPrompt.close();
		}
	};